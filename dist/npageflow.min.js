var e,t;
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function s(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}l((i=i.apply(e,t||[])).next())}))}!function(e){e.SEQUENCE="sequence",e.START="start",e.END="end",e.EXCLUSIVE="exclusive",e.PARALLEL="parallel",e.INCLUSIVE="inclusive",e.MODULE="module"}(e||(e={}));class NNode{constructor(e,t){this.name=e.name,this.process=t}run(){}}class DefineElementManager{static add(e,t){if(Array.isArray(e))for(let t of e)this.elements.set(t.name.toUpperCase(),t);else this.elements.set((t||e.name).toUpperCase(),e)}static get(e){return this.elements.get(e.toUpperCase())}static has(e){return this.elements.has(e.toUpperCase())}}DefineElementManager.elements=new Map;class DirectiveType{constructor(e,t,s){this.name=e,this.prio=s>=0?s:10,this.handle=t}}class DirectiveManager{static addType(e,t,s){this.directiveTypes.set(e,new DirectiveType(e,t,s))}static removeType(e){this.directiveTypes.delete(e)}static getType(e){return this.directiveTypes.get(e)}static hasType(e){return this.directiveTypes.has(e)}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function i(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}l((i=i.apply(e,t||[])).next())}))}DirectiveManager.directiveTypes=new Map;class ModuleFactory{static add(e){0===this.modules.size&&(this.mainModule=e),this.modules.set(e.id,e),this.addClass(e.constructor)}static get(e){return"number"==typeof e?this.modules.get(e):this.getInstance(e)}static hasClass(e){return this.classes.has(e.toLowerCase())}static addClass(e,t){let s=e.name.toLowerCase();this.classes.has(s)||(this.classes.set(s,e),t&&this.classes.set(t.toLowerCase(),e))}static getInstance(e){let t,s="string"==typeof e?e:e.name.toLowerCase();if(t=this.classes.has(s)||"function"!=typeof e?this.classes.get(s):e,!t)return;let i=Reflect.construct(t,[]);return i.init(),i}static remove(e){this.modules.delete(e)}static setMain(e){this.mainModule=e}static getMain(){return this.mainModule}}ModuleFactory.modules=new Map,ModuleFactory.classes=new Map;class Expression{constructor(e){if(this.id=Util.genId(),this.allModelField=!0,!e)return;const t=this.compile(e);this.execFunc=new Function("$model","return "+t)}compile(e){const t=/('[\s\S]*?')|("[\s\S]*?")|(`[\s\S]*?`)|([a-zA-Z$_][\w$]*\s*?:)|((\.{3}|\.)?[a-zA-Z$_][\w$]*(\.[a-zA-Z$_][\w$]*)*(\s*[\[\(](\s*\))?)?)/g;let s,i="",n=0;for(;null!==(s=t.exec(e));){let o=s[0];if(n<s.index&&(i+=e.substring(n,s.index)),"'"===o[0]||'"'===o[0]||"`"===o[0])i+=o;else{let e=o[o.length-1];if(":"===e)i+=o;else if("("===e||")"===e)i+=r(o);else if(o.startsWith("this.")||"$model"===o||o.startsWith("$model.")||Util.isKeyWord(o)||"."===o[0]&&"."!==o[1])i+=o;else{let e="";o.startsWith("...")&&(e="...",o=o.substring(3)),i+=e+"$model."+o,-1!==o.indexOf(".")&&(this.allModelField=!1)}}n=t.lastIndex}return n<e.length&&(i+=e.substring(n)),i;function r(e){let t=e.indexOf(".");if(-1===t){let t=e.lastIndexOf("("),s=e.substring(0,t);if(!Util.isKeyWord(s)){return")"!==e[e.length-1]?'this.invokeMethod("'+s+'",':'this.invokeMethod("'+s+'")'}}else if("."!==e[0]){let s=e.substring(0,t);if(!Util.isKeyWord(s))return"$model."+e}return e}}val(e,t){let s;try{s=this.execFunc.apply(e,[t])}catch(e){}return this.value=s,s}clone(){return this}}class CssManager{static handleStyleDom(e,t,s,i){if("style"!==t.tagName.toLowerCase())return!1;if(i){let i=this.cssPreName+e.id;s.props.class?s.props.class=t.props.class+" "+i:s.props.class=i}return!0}static handleStyleTextDom(e,t){return!(!t.parent||"style"!==t.parent.tagName.toLowerCase())&&(CssManager.addRules(e,t.textContent,"this"===t.parent.props.scope?"."+this.cssPreName+e.id:void 0),!0)}static addRules(e,t,s){if(!this.sheet){let e=document.createElement("style");document.head.appendChild(e),this.sheet=document.styleSheets[0]}s&&this.clearModuleRules(e);const i=/(@[a-zA-Z]+\s+url\(.+?\))|([.#@a-zA-Z]\S*(\s*\S*\s*?)?{)|\}/g,n=/@[a-zA-Z]+\s+url/;let r,o=-1,a=0;for(;null!==(r=i.exec(t));)if(n.test(r[0]))d(r[0]);else if("}"===r[0]){if(o>=0&&--a<=0){let i=t.substring(o,r.index+1);"@"===i[0]?this.sheet.insertRule(i,CssManager.sheet.cssRules?CssManager.sheet.cssRules.length:0):l(e,i,s),o=-1,a=0}}else-1===o?(o=r.index,a++):a++;function l(e,t,s){let i=/.+(?=\{)/.exec(t);if(i){if(s){let n=e.objectManager.get("$cssRules");n||(n=[],e.objectManager.set("$cssRules",n)),n.push(s+" "+i[0]),t=s+" "+t}CssManager.sheet.insertRule(t,CssManager.sheet.cssRules?CssManager.sheet.cssRules.length:0)}}function d(e){let t=e.indexOf("("),s=e.lastIndexOf(")");if(-1===t||-1===s||t>=s)return;let i=e.substring(t,s);CssManager.importMap.has(i)||(CssManager.sheet.insertRule(e,CssManager.importIndex++),CssManager.importMap.set(i,!0))}}static clearModuleRules(e){let t=e.objectManager.get("$cssRules");if(t&&0!==t.length){for(let e=0;e<this.sheet.cssRules.length;e++){let s=this.sheet.cssRules[e];s.selectorText&&-1!==t.indexOf(s.selectorText)&&this.sheet.deleteRule(e--)}e.objectManager.set("$cssRules",[])}}}CssManager.importMap=new Map,CssManager.importIndex=0,CssManager.cssPreName="___nodommodule___";class NEvent{constructor(e,t,s,i){if(this.id=Util.genId(),this.module=e,this.name=t,s){let e=typeof s;if("string"===e){s.trim().split(":").forEach(((e,t)=>{if(e=e.trim(),0===t)this.handler=e;else switch(e){case"delg":this.delg=!0;break;case"nopopo":this.nopopo=!0;break;case"once":this.once=!0;break;case"capture":this.capture=!0}}))}else"function"===e&&(i=s)}if(i&&(this.handler=i),document.ontouchend)switch(this.name){case"click":this.name="tap";break;case"mousedown":this.name="touchstart";break;case"mouseup":this.name="touchend";break;case"mousemove":this.name="touchmove"}else switch(this.name){case"tap":this.name="click";break;case"touchstart":this.name="mousedown";break;case"touchend":this.name="mouseup";break;case"touchmove":this.name="mousemove"}}setParam(e,t,s,i){e.objectManager.setEventParam(this.id,t.key,s,i)}getParam(e,t,s){return e.objectManager.getEventParam(this.id,t.key,s)}removeParam(e,t,s){return e.objectManager.removeEventParam(this.id,t.key,s)}clearParam(e,t){e.objectManager.clearEventParam(this.id,t.key)}}class EventManager{static bind(e,t){const s=e.eventFactory.getEvent(t.key);if(!s)return;const i=t.parent;for(let r of s)if("bindMap"!==r[0]){if(r[1].toDelg)for(let s=0;s<r[1].toDelg.length;s++){let o=r[1].toDelg[s];e.eventFactory.addEvent(i.key,o,t.key),e.eventFactory.bind(i.key,r[0],n,o.capture)}r[1].own&&e.eventFactory.bind(t.key,r[0],n,r[1].capture)}function n(t){let s=t.currentTarget;const i=s.$vdom,n=e.eventFactory.getEvent(i.key);if(!i||!n||!n.has(t.type))return;const r=n.get(t.type);function o(s){if(!s)return;let n=!1;for(let r=0;r<s.length;r++){const o=s[r];"string"==typeof o.handler?e.invokeMethod(o.handler,i.model,i,o,t):"function"==typeof o.handler&&o.handler.apply(e,[i.model,i,o,t]),o.once&&s.splice(r--,1),n=o.nopopo}n&&t.stopPropagation()}function a(n){if(!n)return!1;let r=!1;for(let o=0;o<n.length;o++){const a=n[o],l=a.event;for(let d=0;d<t.path.length&&t.path[d]!==s;d++)if(t.path[d].$vdom&&t.path[d].$vdom.key===a.key){const s=t.path[d].$vdom;"string"==typeof l.handler?e.invokeMethod(l.handler,i.model,i,l,t):"function"==typeof l.handler&&l.handler.apply(e,[i.model,i,l,t]),r=l.nopopo,l.once&&(n.splice(o--,1),e.eventFactory.removeEvent(s.key,l,null,!0));break}}return r}r.capture?(o(r.own),a(r.delg)):a(r.delg)||o(r.own),r.own&&0===r.own.length&&delete r.own,r.delg&&0===r.delg.length&&delete r.delg}}static handleExtendEvent(e,t,s){let i=this.get(s.name);if(!i)return!1;for(let n of Object.keys(i)){let r=new NEvent(e,n,i[n]);r.capture=s.capture,r.nopopo=s.nopopo,r.delg=s.delg,r.once=s.once,r.dependEvent=s,e.eventFactory.addEvent(t.key,r)}return!0}static regist(e,t){this.extendEventMap.set(e,t)}static unregist(e){return this.extendEventMap.delete(e)}static get(e){return this.extendEventMap.get(e)}}EventManager.extendEventMap=new Map;class Renderer{static add(e){this.waitList.includes(e.id)||this.waitList.push(e.id)}static remove(e){let t;-1!==(t=this.waitList.indexOf(e))&&this.waitList.splice(t,1,null)}static render(){for(;this.waitList.length>0;){let e=this.waitList[0];e&&ModuleFactory.get(e).render(),this.waitList.shift()}}static renderDom(e,t,s,i,n){let r={key:n?t.key+"_"+n:t.key,vdom:t};if(t.tagName?(r.tagName=t.tagName,r.props={}):r.textContent=t.textContent,s=t.model||s,i?(s||(s=i.model),r.parent=i):this.currentModuleRoot=r,s||(s=e.model),r.model=s,r.staticNum=t.staticNum,t.staticNum>0&&t.staticNum--,t.directives&&t.directives.length>0&&"model"===t.directives[0].type.name&&t.directives[0].exec(e,r),r.tagName){if(!r.notChange){if(function(){if(!t.props||0===t.props.size)return;const s=/^style$/i,i=/^class$/i;let n;for(let o of t.props){if(Array.isArray(o[1])){n=[];for(let t=0;t<o[1].length;t++){let s=o[1][t];s instanceof Expression?(n.push(s.val(e,r.model)),r.staticNum=-1):n.push(s)}s.test(o[0])?n=t.getStyleString(n):i.test(o[0])&&(n=t.getClassString(n))}else o[1]instanceof Expression?(n=o[1].val(e,r.model),r.staticNum=-1):n=o[1];r.props[o[0]]=n}}(),!CssManager.handleStyleDom(e,t,Renderer.currentModuleRoot,"this"===t.getProp("scope"))&&t.assets&&t.assets.size>0)for(let e of t.assets)r[e[0]]=e[1];if(!function(){if(!t.directives||0===t.directives.length)return!0;r.staticNum=-1;for(let s of t.directives)if("model"!==s.type.name&&!s.exec(e,r))return!1;return!0}())return null}if(t.events&&!e.eventFactory.getEvent(r.key))for(let s of t.events)e.eventFactory.addEvent(r.key,s);if(t.children&&t.children.length>0){r.children=[];for(let s of t.children)Renderer.renderDom(e,s,r.model,r,n||null)}}else if(!r.notChange)if(t.expressions){let s="";t.expressions.forEach((t=>{if(t instanceof Expression){let i=t.val(e,r.model);s+=void 0!==i?i:""}else s+=t})),r.textContent=s,r.staticNum=-1}else r.textContent=t.textContent;return i&&i.children.push(r),r}static updateToHtml(e,t){let s=e.getElement(t.key);if(!s)return this.renderToHtml(e,t,null);if(t.tagName){s.$vdom=t,e.saveElement(t.key,s);let i=s.attributes,n=[];for(let e=0;e<i.length;e++)n.push(i[e].name);for(let e of Object.keys(t.props)){let i;s.setAttribute(e,void 0===t.props[e]?"":t.props[e]),-1!==(i=n.indexOf(e))&&n.splice(i,1)}if(n.length>0)for(let e of n)s.removeAttribute(e);if(t.assets)for(let e of Object.keys(t.assets))s[e]=t.assets[e]}else s.textContent=t.textContent;return s}static renderToHtml(e,t,s,i){let n;return n=t.tagName?r(t):o(t),n&&t.tagName&&i&&function e(t,s){s.children&&s.children.length>0&&s.children.forEach((s=>{let i;s.tagName?(i=r(s),e(i,s)):i=o(s),i&&t.appendChild(i)}))}(n,t),n&&s&&s.appendChild(n),n;function r(t){if("style"===t.tagName.toLowerCase())return;let s=document.createElement(t.tagName);if(s.$vdom=t,e.saveElement(t.key,s),t.props.key&&e.saveElement(t.props.key,s),!t.subModuleId){for(let e of Object.keys(t.props))s.setAttribute(e,void 0===t.props[e]?"":t.props[e]);if(t.assets)for(let e of Object.keys(t.assets))s[e]=t.assets[e];EventManager.bind(e,t)}return s}function o(t){if(CssManager.handleStyleTextDom(e,t))return;let s=document.createTextNode(t.textContent||"");return e.saveElement(t.key,s),s}}static handleChangedDoms(e,t){for(let s of t){let t={};s[1]&&(t.new=e.getElement(s[1].key)),s[2]&&(t.old=e.getElement(s[2].key)),s[3]&&(t.p=e.getElement(s[3].key)),s.els=t,3===s[0]?e.freeNode(s[1]):5===s[0]&&e.freeNode(s[2])}const s=[];for(let i of t){let t,n,r;switch(i[0]){case 1:t=i.els.p,n=Renderer.renderToHtml(e,i[1],null,!0),t.children&&t.children.length-1>i[4]?t.insertBefore(n,t.children[i[4]]):t.appendChild(n);break;case 2:Renderer.updateToHtml(e,i[1]);break;case 3:t=i.els.p,n=i.els.new,t&&n&&n.parentElement===t&&t.removeChild(n);break;case 4:t=i.els.p,n=e.getElement(i[1].key),n&&n!==t.children[i[4]]&&(t.children.length>i[4]?t.insertBefore(n,t.children[i[4]]):t.children.length===i[4]?t.appendChild(n):s.push(i));break;case 5:t=i.els.p,r=i.els.old,n=Renderer.renderToHtml(e,i[1],null,!0),t&&r&&t.replaceChild(n,r)}}for(let t=0;t<s.length;t++){const i=s[t],n=e.getElement(i[3].key),r=e.getElement(i[1].key);r&&r!==n.children[i[4]]&&(n.children.length>i[4]?n.insertBefore(r,n.children[i[4]]):n.appendChild(r))}}}Renderer.waitList=[];class ModelManager{static getMap(){return this.modelMap}static getModel(e,t){if(this.dataMap.has(e)){const t=this.dataMap.get(e);if(this.tempMap.has(e)){const s=this.getModuleIds(t),i=this.tempMap.get(e);this.tempMap.delete(e);for(let e of i)-1===s.indexOf(e)&&s.push(e)}return t}}static getModelKey(e){if(this.modelMap.has(e))return this.modelMap.get(e).key}static add(e,t,s){this.dataMap.set(e,t);let i=[];s&&(i=this.getModuleIds(s).slice(0)),this.modelMap.set(t,{key:Util.genId(),modules:i})}static bindToModule(e,t,s){this.modelMap.has(e)||this.modelMap.set(e,{key:Util.genId()});let i=this.modelMap.get(e);i.modules?-1===i.modules.indexOf(t.id)&&i.modules.push(t.id):i.modules=[t.id],s&&function e(s,i){for(let n of Object.keys(s))if(s[n]&&"object"==typeof s[n]){let r=s[n].___source;i.has(r)?i.get(r).push(t.id):i.set(r,[t.id]),e(s[n],i)}}(e,this.tempMap)}static getModuleIds(e){if(this.modelMap.has(e))return this.modelMap.get(e).modules}static update(e,t,s,i){const n=this.getModuleIds(e);if(!n)return;for(let e of n){const t=ModuleFactory.get(e);t&&Renderer.add(t)}let r=this.modelMap.get(e).watchers;if(!r)return;if(!r.has(t))return;let o=r.get(t);for(let n of o)for(let r of n[1]){const o=ModuleFactory.get(r);o&&n[0].call(o,e,t,s,i)}}static watch(e,t,s,i,n){let r=i?[i.id]:ModelManager.getModuleIds(e),o=[];if(Array.isArray(t))for(let i of t)a(e,i,s);else a(e,t,s);return()=>{if(o)for(let e of o){let t=ModelManager.modelMap.get(e.m).watchers;t&&t.has(e.k)&&(e.operate?t.get(e.k).has(e.operate)&&t.get(e.k).delete(e.operate):t.delete(e.k))}o=null};function a(e,t,s){let i=-1;if(-1!==(i=t.lastIndexOf("."))&&(e=ModelManager.get(e,t.substring(0,i)),t=t.substring(i+1)),!e)return;const l=ModelManager.modelMap.get(e);l.watchers||(l.watchers=new Map);let d=l.watchers;if(d.has(t)||d.set(t,new Map),d.get(t).set(s,r),o.push({m:e,k:t,f:s}),n&&e[t]&&"object"==typeof e[t])for(let i of Object.keys(e[t]))"function"!=typeof e[t][i]&&a(e[t],i,s)}}static get(e,t){if(t){if(-1!==t.indexOf(".")){let s=t.split(".");for(let t=0;t<s.length-1&&(e=e[s[t]]);t++);if(!e)return;t=s[s.length-1]}e=e[t]}return e}static set(e,t,s){if(-1!==t.indexOf(".")){let s=t.split(".");for(let t=0;t<s.length-1;t++)e[s[t]]||(e[s[t]]={}),e=e[s[t]];t=s[s.length-1]}e[t]=s}static isModel(e){return null!=e&&void 0!==e.___source}}ModelManager.dataMap=new WeakMap,ModelManager.modelMap=new Map,ModelManager.tempMap=new WeakMap;class Route{constructor(e,t){if(this.params=[],this.data={},this.children=[],e&&!Util.isEmpty(e.path)){this.id=Util.genId();for(let t of Object.keys(e))this[t]=e[t];this.parent=t,this.path&&this.parse(),t&&t.addChild(this),e.routes&&Array.isArray(e.routes)&&e.routes.forEach((e=>{new Route(e,this)}))}}addChild(e){this.children.push(e),e.parent=this}parse(){let e=this.path.split("/"),t=this.parent,s=[],i=-1,n="";for(let r=0;r<e.length;r++){let o=e[r].trim();if(""!==o){if(o.startsWith(":"))0===s.length&&(i=r),s.push(o.substring(1));else{i=-1,s=[],this.path=o;let e=0;for(;e<t.children.length;e++){let s=t.children[e];if(s.path===o){t=s;break}}e===t.children.length&&(""!==n&&(new Route({path:n},t),t=t.children[t.children.length-1]),n=o)}this.params=-1===i?[]:s}else e.splice(r--,1)}}clone(){let e=new Route;return Object.getOwnPropertyNames(this).forEach((t=>{"data"!==t&&(e[t]=this[t])})),this.data&&(e.data=Util.clone(this.data)),e}}!function(e){e[e.READY=1]="READY",e[e.UNMOUNTED=3]="UNMOUNTED",e[e.MOUNTED=4]="MOUNTED"}(t||(t={}));class Router{static go(e){e!==this.currentPath&&(-1===this.waitList.indexOf(e)&&this.waitList.push(e),setTimeout((()=>{this.load()}),0))}static load(){if(0===this.waitList.length)return;let e=this.waitList.shift();this.start(e).then((()=>{this.load()}))}static start(e){return i(this,void 0,void 0,(function*(){let t,s=this.compare(this.currentPath,e);t=null===s[0]?ModuleFactory.getMain():yield this.getModule(s[0]);for(let e=s[1].length-1;e>=0;e--){const t=s[1][e];if(!t.module)continue;let i=yield this.getModule(t);Util.isFunction(this.onDefaultLeave)&&this.onDefaultLeave(i.model),Util.isFunction(t.onLeave)&&t.onLeave(i.model),this.activeFieldMap.delete(i.id),i.unmount()}if(0===s[2].length){let e=s[0];if(null!==e){let t=yield this.getModule(e);this.dependHandle(t,e,s[3]?s[3].module:null)}}else for(let e=0;e<s[2].length;e++){let i=s[2][e];if(!i||!i.module)continue;let n=yield this.getModule(i);this.dependHandle(n,i,t),Util.isFunction(this.onDefaultEnter)&&this.onDefaultEnter(n.model),Util.isFunction(i.onEnter)&&i.onEnter(n.model),t=n}if(0===this.startStyle){let t=(Router.basePath||"")+e;e.startsWith(this.currentPath)?history.replaceState(t,"",t):history.pushState(t,"",t)}this.currentPath=e,this.startStyle=0}))}static redirect(e){this.go(e)}static getModule(e){return i(this,void 0,void 0,(function*(){let t=e.module;if("object"==typeof t)return t;if(!t.__proto__.name){const e=yield t();for(let s of Object.keys(e))if(e[s].name){t=e[s];break}}return"function"==typeof t&&(t=ModuleFactory.get(t)),e.module=t,t}))}static compare(e,t){let s=null,i=null;e&&(s=this.getRouteList(e,!0)),t&&(i=this.getRouteList(t));let n=0;null!==s&&(n=s.length),null!==i?i.length<n&&(n=i.length):n=0;let r=[],o=[],a=0;for(a=0;a<n&&s[a].id===i[a].id;a++)if(JSON.stringify(s[a].data)!==JSON.stringify(i[a].data)){a++;break}null!==s&&(r=s.slice(a)),null!==i&&(o=i.slice(a));let l=null,d=null;if(i&&a>0)for(let e=a-1;e>=0;e--)if(l){if(!d&&i[e].module){d=i[e];break}}else if(i[e].module){l=i[e];continue}return[l,r,o,d]}static addActiveField(e,t,s,i){if(!s||!i)return;let n=Router.activeFieldMap.get(e.id);n?void 0===n.find((e=>e.model===s&&e.field===i))&&n.push({path:t,model:s,field:i}):Router.activeFieldMap.set(e.id,[{path:t,model:s,field:i}])}static dependHandle(e,s,i){const n=this;let r={path:s.path};if(Util.isEmpty(s.data)||(r.data=s.data),e.model.$route=r,i)if(i.state===t.MOUNTED)e.setContainer(i.getElement(Router.routerKeyMap.get(i.id))),e.active(),this.setDomActive(i,s.fullPath);else if(i.onMount){const t=i.onMount;i.onMount=r=>{t(r),e.setContainer(i.getElement(Router.routerKeyMap.get(i.id))),e.active(),n.setDomActive(i,s.fullPath),i.onMount=t}}else i.onMount=t=>{e.setContainer(i.getElement(Router.routerKeyMap.get(i.id))),e.active(),n.setDomActive(i,s.fullPath),delete i.onMount}}static setDomActive(e,t){let s=Router.activeFieldMap.get(e.id);if(s)for(let e of s)e.model[e.field]=e.path===t}static getRouteList(e,t){if(!this.root)return[];let s=e.split("/"),i=this.root,n=0,r=[],o="",a=this.root;for(let e=0;e<s.length;e++){let l=s[e].trim();if(""===l)continue;let d=!1;for(let e=0;e<i.children.length;e++)if(i.children[e].path===l){a!==this.root&&(a.fullPath=o,a.data=i.data,r.push(a)),i=t?i.children[e].clone():i.children[e],i.data={},a=i,d=!0,n=0;break}o+="/"+l,d||n<i.params.length&&(i.data[i.params[n++]]=l)}return i!==this.root&&(i.fullPath=o,r.push(i)),r}}function n(e,t,s){return DirectiveManager.addType(e,t,s)}Router.waitList=[],Router.startStyle=0,Router.activeFieldMap=new Map,Router.routerKeyMap=new Map,Router.root=new Route,window.addEventListener("popstate",(function(e){const t=history.state;t&&(Router.startStyle=1,Router.go(t))}));class NError extends Error{constructor(e,t,s,i,n){super(e),undefined.ErrorMsgs[e],this.message="未知错误"}compile(e,t,s,i,n,r){let o,a=arguments,l=0;for(;-1!==e.indexOf("{"+l+"}");)o=new RegExp("\\{"+l+"\\}","g"),e=e.replace(o,a[l+1]),l++;return e}}class Util{static genId(){return this.generatedId++}static initKeyMap(){this.keyWordMap.set("arguments",!0),this.keyWordMap.set("boolean",!0),this.keyWordMap.set("break",!0),this.keyWordMap.set("byte",!0),this.keyWordMap.set("catch",!0),this.keyWordMap.set("char",!0),this.keyWordMap.set("const",!0),this.keyWordMap.set("default",!0),this.keyWordMap.set("delete",!0),this.keyWordMap.set("do",!0),this.keyWordMap.set("double",!0),this.keyWordMap.set("else",!0),this.keyWordMap.set("enum",!0),this.keyWordMap.set("eval",!0),this.keyWordMap.set("false",!0),this.keyWordMap.set("float",!0),this.keyWordMap.set("for",!0),this.keyWordMap.set("function",!0),this.keyWordMap.set("goto",!0),this.keyWordMap.set("if",!0),this.keyWordMap.set("in",!0),this.keyWordMap.set("instanceof",!0),this.keyWordMap.set("int",!0),this.keyWordMap.set("let",!0),this.keyWordMap.set("long",!0),this.keyWordMap.set("new",!0),this.keyWordMap.set("null",!0),this.keyWordMap.set("return",!0),this.keyWordMap.set("short",!0),this.keyWordMap.set("switch",!0),this.keyWordMap.set("this",!0),this.keyWordMap.set("throw",!0),this.keyWordMap.set("true",!0),this.keyWordMap.set("try",!0),this.keyWordMap.set("this",!0),this.keyWordMap.set("throw",!0),this.keyWordMap.set("typeof",!0),this.keyWordMap.set("var",!0),this.keyWordMap.set("while",!0),this.keyWordMap.set("with",!0),this.keyWordMap.set("Array",!0),this.keyWordMap.set("Date",!0),this.keyWordMap.set("JSON",!0),this.keyWordMap.set("Set",!0),this.keyWordMap.set("Map",!0),this.keyWordMap.set("eval",!0),this.keyWordMap.set("function",!0),this.keyWordMap.set("Infinity",!0),this.keyWordMap.set("isFinite",!0),this.keyWordMap.set("isNaN",!0),this.keyWordMap.set("isPrototypeOf",!0),this.keyWordMap.set("Math",!0),this.keyWordMap.set("NaN",!0),this.keyWordMap.set("Number",!0),this.keyWordMap.set("Object",!0),this.keyWordMap.set("prototype",!0),this.keyWordMap.set("String",!0),this.keyWordMap.set("isPrototypeOf",!0),this.keyWordMap.set("undefined",!0),this.keyWordMap.set("valueOf",!0)}static isKeyWord(e){return this.keyWordMap.has(e)}static clone(e,t,s){let i=this,n=new WeakMap;return r(e,t,s);function r(e,t,s){if(!e||"object"!=typeof e||Util.isFunction(e))return e;let r;return e.clone&&Util.isFunction(e.clone)?e.clone(s):(i.isObject(e)?(r=new Object,n.set(e,r),Object.getOwnPropertyNames(e).forEach((i=>{t&&(t.constructor===RegExp&&t.test(i)||Util.isArray(t)&&t.includes(i))||(r[i]=o(e[i],t,s))}))):i.isMap(e)?(r=new Map,e.forEach(((e,i)=>{t&&(t.constructor===RegExp&&t.test(i)||t.includes(i))||r.set(i,o(e,t,s))}))):i.isArray(e)&&(r=new Array,e.forEach((function(e,i){r[i]=o(e,t,s)}))),r)}function o(e,t,s){if("object"==typeof e&&!Util.isFunction(e)){let i=null;return i=n.has(e)?n.get(e):r(e,t,s),i}return e}}static merge(e,t,s,i,n,r){let o=this;for(let e=0;e<arguments.length;e++)if(!this.isObject(arguments[e]))throw new NError("invoke","Util.merge",e+"","object");let a=Object.assign.apply(null,arguments);return function(e){for(let t of Object.keys(e))(o.isObject(e[t])||o.isArray(e[t]))&&(a[t]=o.clone(a[t]))}(a),a}static assign(e,t){return Object.assign?Object.assign(e,t):this.getOwnProps(t).forEach((function(s){e[s]=t[s]})),e}static compare(e,t,s){if(!e&&!t)return!0;if("object"!=typeof e||"object"!=typeof t)return!1;const i=Object.getOwnPropertyNames(e);if(i.length!==Object.getOwnPropertyNames(t).length)return!1;for(let s of i)if(e[s]!==t[s])return!1;if(s)for(let s of i){if(!this.compare(e[s],t[s]))return!1}return!0}static getOwnProps(e){return e?Object.getOwnPropertyNames(e):[]}static isFunction(e){return null!=e&&e.constructor===Function}static isArray(e){return Array.isArray(e)}static isMap(e){return null!=e&&e.constructor===Map}static isObject(e){return null!=e&&e.constructor===Object}static isInt(e){return Number.isInteger(e)}static isNumber(e){return"number"==typeof e}static isBoolean(e){return"boolean"==typeof e}static isString(e){return"string"==typeof e}static isNumberString(e){return/^\d+\.?\d*$/.test(e)}static isEmpty(e){if(null==e)return!0;let t=typeof e;if(this.isObject(e)){let t=Object.keys(e);if(void 0!==t)return 0===t.length}else if("string"===t)return""===e;return!1}static replaceNode(e,t){let s=e.parentNode,i=e.nextSibling;if(null===s)return;s.removeChild(e);(this.isArray(t)?t:[t]).forEach((function(e){null==i?s.appendChild(e):s.insertBefore(e,i)}))}static empty(e){let t=e.childNodes;for(let s=t.length-1;s>=0;s--)e.removeChild(t[s])}static formatDate(e,t){if(this.isString(e)){if(!/^\d+$/.test(e))throw new NError("invoke","Util.formatDate","0","date string","date");e=Number(e)}let s=new Date(e);if(isNaN(s.getDay()))throw new NError("invoke","Util.formatDate","0","date string","date");let i,n={"M+":s.getMonth()+1,"d+":s.getDate(),"h+":s.getHours(),"H+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),S:s.getMilliseconds()};return(i=/(y+)/.exec(t))&&(t=t.replace(i[0],(s.getFullYear()+"").substring(4-i[0].length))),this.getOwnProps(n).forEach((function(e){(i=new RegExp("("+e+")").exec(t))&&(t=t.replace(i[0],1===i[0].length?n[e]:("00"+n[e]).substring((n[e]+"").length)))})),t=t.replace(/(E+)/,undefined.WeekDays[s.getDay()+""])}static compileStr(e,t,s,i,n,r){let o,a=arguments,l=0;for(;-1!==e.indexOf("{"+l+"}");)o=new RegExp("\\{"+l+"\\}","g"),e=e.replace(o,a[l+1]),l++;return e}static apply(e,t,s){if(e)return Reflect.apply(e,t||null,s)}static mergePath(e){return e.join("/").replace(/(\/{2,})|\\\//g,"/")}static eval(e){return new Function(`return(${e})`)()}static setNodeKey(e,t,s){if(e.key+="_"+(t||Util.genId()),s&&e.children)for(let i of e.children)Util.setNodeKey(i,t,s)}static setDomAsset(e,t,s){e.assets||(e.assets={}),e.assets[t]=s}static delDomAsset(e,t){e.assets&&delete e.assets[t]}}Util.generatedId=1,Util.keyWordMap=new Map,Util.initKeyMap();class Directive{constructor(e,t){if(this.id=Util.genId(),e&&(this.type=DirectiveManager.getType(e),!this.type))throw new NError("notexist1",undefined.TipWords.directive,e);Util.isString(t)?this.value=t.trim():t instanceof Expression?this.expression=t:this.value=t}exec(e,t){return!!this.disabled||(this.expression&&(this.value=this.expression.val(e,t.model)),this.type.handle.apply(this,[e,t]))}clone(){let e=new Directive;return e.type=this.type,e.expression=this.expression,e.value=this.value,e}}class DefineElement{constructor(e){e.hasProp("tag")?(e.tagName=e.getProp("tag"),e.delProp("tag")):e.tagName="div"}}class GlobalCache{static set(e,t){this.cache.set(e,t)}static get(e){return this.cache.get(e)}static subscribe(e,t,s){this.cache.subscribe(e,t,s)}static remove(e){this.cache.remove(e)}}GlobalCache.cache=new class NCache{constructor(){this.subscribeMap=new Map,this.cacheData={}}get(e){let t=this.cacheData;if(-1!==e.indexOf(".")){let s=e.split(".");if(s.length>1){for(let e=0;e<s.length-1&&t;e++)t=t[s[e]];t&&(e=s[s.length-1])}}if(t)return t[e]}set(e,t){let s=this.cacheData,i=e;if(-1!==e.indexOf(".")){let t=e.split(".");if(t.length>1){for(let e=0;e<t.length-1;e++)s[t[e]]&&"object"==typeof s[t[e]]||(s[t[e]]={}),s=s[t[e]];e=t[t.length-1]}}if(s&&(s[e]=t),this.subscribeMap.has(i)){let e=this.subscribeMap.get(i);for(let s of e)this.invokeSubscribe(s.module,s.handler,t)}}remove(e){let t=this.cacheData;if(-1!==e.indexOf(".")){let s=e.split(".");if(s.length>1){for(let e=0;e<s.length-1&&t;e++)t=t[s[e]];t&&(e=s[s.length-1])}}t&&delete t[e]}subscribe(e,t,s){if(this.subscribeMap.has(t)){let i=this.subscribeMap.get(t);i.find((t=>t.module===e&&t.handler===s))||i.push({module:e,handler:s})}else this.subscribeMap.set(t,[{module:e,handler:s}]);let i=this.get(t);i&&this.invokeSubscribe(e,s,i)}invokeSubscribe(e,t,s){"string"==typeof t?e.invokeMethod(t,s):t.call(e,s)}};class Model{constructor(e,t){if(!e)return;let s;return e.___source?s=e:(s=new Proxy(e,{set(e,t,s,i){if(null!==s&&"object"==typeof s&&(s=s.___source||s),e[t]===s)return!0;let n=e[t],r=Reflect.set(e,t,s,i);return ModelManager.update(i,t,n,s),r},get(e,t,s){if("___source"===t)return e;let i=Reflect.get(e,t,s);if(i&&(i.constructor===Object||i.constructor===Array)){let e=ModelManager.getModel(i,s);e||(e=new Model(i,s),ModelManager.add(i,e,s)),i=e}return i},deleteProperty(e,t){let s=e[t];return delete e[t],ModelManager.update(ModelManager.getModel(e),t,s,void 0),!0}}),ModelManager.add(e,s)),t&&ModelManager.bindToModule(s,t,void 0!==e.___source),s}}DefineElementManager.add([class MODULE extends DefineElement{constructor(e,t){super(e);let s=e.getProp("name");if(!s)throw new NError("itemnotempty",undefined.TipWords.element,"MODULE","className");e.delProp("name"),e.addDirective(new Directive("module",s))}},class FOR extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",undefined.TipWords.element,"FOR","cond");e.delProp("cond"),e.addDirective(new Directive("repeat",s))}},class IF extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",undefined.TipWords.element,"IF","cond");e.delProp("cond"),e.addDirective(new Directive("if",s))}},class RECUR extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");e.delProp("cond"),e.addDirective(new Directive("recur",s))}},class ELSE extends DefineElement{constructor(e,t){super(e),e.addDirective(new Directive("else",null))}},class ELSEIF extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",undefined.TipWords.element,"ELSEIF","cond");e.delProp("cond"),e.addDirective(new Directive("elseif",s))}},class ENDIF extends DefineElement{constructor(e,t){super(e),e.addDirective(new Directive("endif",null))}},class SLOT extends DefineElement{constructor(e,t){super(e);let s=e.getProp("name")||"default";e.delProp("name"),e.addDirective(new Directive("slot",s))}}]),n("module",(function(e,t){const s=t.vdom;let i,n=e.objectManager.getDomParam(t.key,"moduleId"),r=!0;if(n)i=ModuleFactory.get(n),r=!t.props.renderOnce;else{if(i=ModuleFactory.get(this.value),!i)return!0;this.params&&this.params.srcId&&(i.compileMid=this.params.srcId),n=i.id,e.objectManager.setDomParam(t.key,"moduleId",n),e.addChild(i),s.hasProp("useDomModel")&&(i.model=t.model,ModelManager.bindToModule(i.model,i),delete t.props.useDomModel)}if(t.subModuleId=n,delete t.tagName,r){let e={};if(t.props)for(let s of Object.keys(t.props)){let i=t.props[s];"$"===s[0]?(e.$data||(e.$data={}),e.$data[s.substring(1)]=i,delete t.props[s]):e[s]=i}i.setProps(e,t)}return!0}),8),n("model",(function(e,t){let s=ModelManager.get(t.model,this.value);return s&&(t.model=s),!0}),1),n("repeat",(function(e,t){let s=this.value;if(!Util.isArray(s)||0===s.length)return!1;const i=t.vdom,n=i.getProp("$index"),r=t.parent;this.disabled=!0,delete i.model;for(let t=0;t<s.length;t++){if(!s[t])continue;n&&(s[t][n]=t),i.staticNum++;let o=Renderer.renderDom(e,i,s[t],r,ModelManager.getModelKey(s[t])+"");n&&delete o.props.$index}return this.disabled=!1,!1}),2),n("recur",(function(e,t){const s=t.vdom;if(t.props.hasOwnProperty("ref")){s.children=[];const i="$recurs."+(t.props.ref||"default");let n=e.objectManager.get(i);if(!n)return!0;let r=t.model[n.getDirective("recur").value];if(!r)return!0;let o=n.clone();Array.isArray(r)||(o.model=r,Util.setNodeKey(o,ModelManager.getModelKey(r)+"",!0)),s.children=[o],o.parent=s}else{if(!t.model[this.value])return!0;const i="$recurs."+(t.props.name||"default");e.objectManager.get(i)||e.objectManager.set(i,s)}return!0}),2),n("if",(function(e,t){if(t.parent)return e.objectManager.setDomParam(t.parent.key,"$if",this.value),this.value}),5),n("else",(function(e,t){if(t.parent)return!e.objectManager.getDomParam(t.parent.key,"$if")}),5),n("elseif",(function(e,t){if(t.parent)return!0!==e.objectManager.getDomParam(t.parent.key,"$if")&&!!this.value&&(e.objectManager.setDomParam(t.parent.key,"$if",!0),!0)}),5),n("endif",(function(e,t){if(t.parent)return e.objectManager.removeDomParam(t.parent.key,"$if"),!1}),5),n("show",(function(e,t){let s=e.objectManager.getDomParam(t.key,"$show");if(!(this.value||s&&s.rendered))return!1;s||(s={},e.objectManager.setDomParam(t.key,"$show",s));let i,n,r=t.props.style;return r&&(i=/display\s*\:[\w\-]+/.exec(r),null!==i)&&(n=i[0].split(":")[1].trim(),s.origin||"none"===n||(s.origin=n)),this.value?(s.rendered=!0,"none"===n&&(r=s.origin?r.substring(0,i.index)+"display:"+s.origin+r.substring(i.index+i[0].length):r.substring(0,i.index)+r.substring(i.index+i[0].length))):r?n?"none"!==n&&(r=r.substring(0,i.index)+"display:none"+r.substring(i.index+i[0].length)):r+=";display:none":r="display:none",r&&(t.props.style=r),!0}),5),n("field",(function(e,t){const s=t.props.type||"text",i=t.tagName.toLowerCase(),n=t.model;if(!n)return!0;let r=ModelManager.get(n,this.value);if("radio"===s)r==t.props.value?(t.props.checked="checked",Util.setDomAsset(t,"checked",!0)):(delete t.props.checked,Util.setDomAsset(t,"checked",!1));else if("checkbox"===s){let e=t.props["yes-value"];r==e?(t.props.value=e,Util.setDomAsset(t,"checked",!0)):(t.props.value=t.props["no-value"],Util.setDomAsset(t,"checked",!1))}else if("select"===i)t.props.value=r,Util.setDomAsset(t,"value",r);else{let e=null!=r?r:"";t.props.value=e,Util.setDomAsset(t,"value",e)}let o=GlobalCache.get("$fieldChangeEvent");return o||(o=new NEvent(null,"change",(function(e,t){const s=this.getElement(t.key);if(!s)return;let i=t.vdom.getDirective("field"),n=t.props.type,r=i.value,o=s.value;"checkbox"===n?o=t.props["yes-value"]==o?t.props["no-value"]:t.props["yes-value"]:"radio"===n&&(s.checked||(o=void 0));let a=r.split(".");if(1===a.length)e[r]=o;else{let t=e;r=a.pop();for(let e=0;e<a.length&&t;e++)t=t[a[e]];t&&(t[r]=o)}})),GlobalCache.set("$fieldChangeEvent",o)),t.vdom.addEvent(o),!0}),10),n("route",(function(e,t){if("a"===t.tagName.toLowerCase()&&(t.props.href="javascript:void(0)"),t.props.path=this.value,t.props.active){let s=t.props.active;delete t.props.active,Router.addActiveField(e,this.value,t.model,s),this.value.startsWith(Router.currentPath)&&t.model[s]&&Router.go(this.value)}let s=GlobalCache.get("$routeClickEvent");return s||(s=new NEvent(null,"click",(function(e,t,s,i){let n=t.props.path;Util.isEmpty(n)||Router.go(n)})),GlobalCache.set("$routeClickEvent",s)),t.vdom.addEvent(s),!0}),10),n("router",(function(e,t){return Router.routerKeyMap.set(e.id,t.key),!0}),10),n("slot",(function(e,t){this.value=this.value||"default";let s=t.parent.subModuleId;const i=t.vdom;if(s){let e=ModuleFactory.get(s);e&&e.objectManager.set("$slots."+this.value,{dom:i,model:t.model})}else{const s=e.objectManager.get("$slots."+this.value),n=s?s.dom.children:i.children;if(n)for(let r of n){let n;i.hasProp("innerRender")?n=t.model:s&&(n=new Model(s.model,e)),Renderer.renderDom(e,r,n,t.parent,t.key+"s")}}return!1}),5),n("animation",(function(e,t){var s,i,n,r,o,a,l,d,c,u,h,p,f,g,m,y,v,M,k,w;const b=this.value;if(!Util.isObject(b))return new Error("未找到animation配置对象");const E=0!=b.tigger,N=b.type||"transition",x=0!=b.isAppear,D=(null===(s=b.name)||void 0===s?void 0:s.enter)||b.name,P=(null===(i=b.name)||void 0===i?void 0:i.leave)||b.name,S=(null===(n=b.duration)||void 0===n?void 0:n.enter)||b.duration||"",C=(null===(r=b.duration)||void 0===r?void 0:r.leavr)||b.duration||"",W=(null===(o=b.delay)||void 0===o?void 0:o.enter)||b.delay||"0s",O=(null===(a=b.delay)||void 0===a?void 0:a.leave)||b.delay||"0s",L=(null===(l=b.timingFunction)||void 0===l?void 0:l.enter)||b.timingFunction||"ease",R=(null===(d=b.timingFunction)||void 0===d?void 0:d.leave)||b.timingFunction||"ease",F=(null===(u=null===(c=b.hooks)||void 0===c?void 0:c.enter)||void 0===u?void 0:u.before)?b.hooks.enter.before:(null===(h=b.hooks)||void 0===h?void 0:h.before)||void 0,$=(null===(f=null===(p=b.hooks)||void 0===p?void 0:p.enter)||void 0===f?void 0:f.after)?b.hooks.enter.after:(null===(g=b.hooks)||void 0===g?void 0:g.after)||void 0,j=(null===(y=null===(m=b.hooks)||void 0===m?void 0:m.leave)||void 0===y?void 0:y.before)?b.hooks.leave.before:(null===(v=b.hooks)||void 0===v?void 0:v.before)||void 0,A=(null===(k=null===(M=b.hooks)||void 0===M?void 0:M.leave)||void 0===k?void 0:k.after)?b.hooks.leave.after:(null===(w=b.hooks)||void 0===w?void 0:w.after)||void 0;let U=()=>{const s=e.getElement(t.key);E?($&&$.apply(e.model,[e]),s.classList.remove(D+"-enter-active"),"animation"==N&&s.classList.add(D+"-enter-to")):(x&&(s.style.display="none"),A&&A.apply(e.model,[e]),[s.style.width,s.style.height]=function(e){const t=e.vdom.getProp("style");let s,i;if(t){let e=t.trim().split(/;\s*/);for(const t of e)t.startsWith("width")&&(s=t.split(":")[1]),t.startsWith("height")&&(i=t.split(":")[1])}return s=s||"",i=i||"",[s,i]}(t),s.classList.remove(P+"-leave-active"),"animation"==N&&s.classList.add(P+"-leave-to")),s.removeEventListener("animationend",U),s.removeEventListener("transitionend",U)},T=e.getElement(t.key);if(E){if(T){if(-1!=T.getAttribute("class").indexOf(`${D}-enter-to`))return t.props.class+=` ${D}-enter-to`,!0;x&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),q(T)}else x&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),setTimeout((()=>{let s=e.getElement(t.key);x&&(t.props.class+=` ${D}-enter-to`,s.style.display="none"),q(s)}),0);return!0}return T?-1!=T.getAttribute("class").indexOf(`${P}-leave-to`)?(t.props.class+=` ${P}-leave-to`,x&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),!0):(I(T),!0):(x&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),setTimeout((()=>{let s=e.getElement(t.key);x?(s.classList.add(`${P}-leave-to`),t.props.class+=` ${P}-leave-to`,s.style.display="none"):I(s)}),0),!0);function I(t){if("transition"==N){let[s,i]=_(t);requestAnimationFrame((()=>{t.classList.remove(D+"-enter-to"),t.classList.add(P+"-leave-active"),t.classList.add(P+"-leave-from"),"fold-height"==P?t.style.height=i:"fold-width"==P&&(t.style.width=s),t.style.transitionDelay=W,""!=S&&(t.style.transitionDuration=S),"ease"!=L&&(t.style.transitionTimingFunction=L),j&&j.apply(e.model,[e]),requestAnimationFrame((()=>{t.classList.add(P+"-leave-to"),t.classList.remove(P+"-leave-from"),"fold-height"==P?t.style.height="0px":"fold-width"==P&&(t.style.width="0px"),t.addEventListener("transitionend",U)}))}))}else requestAnimationFrame((()=>{t.classList.remove(D+"-enter-to"),t.style.animationDelay=O,""!=C&&(t.style.animationDuration=C),"ease"!=R&&(t.style.animationTimingFunction=R),j&&j.apply(e.model,[e]),t.offsetWidth,t.classList.add(P+"-leave-active"),t.addEventListener("animationend",U)}))}function q(t){if("transition"==N){t.style.transitionDelay="0s";let s=1e3*parseFloat(W);setTimeout((()=>{let[s,i]=_(t);t.classList.remove(P+"-leave-to"),t.classList.add(D+"-enter-active"),t.classList.add(D+"-enter-from"),"fold-height"==D?t.style.height="0px":"fold-width"==D&&(t.style.width="0px"),""!=S&&(t.style.transitionDuration=S),"ease"!=L&&(t.style.transitionTimingFunction=L),requestAnimationFrame((()=>{x&&(t.style.display=""),requestAnimationFrame((()=>{F&&F.apply(e.model,[e]),t.classList.add(D+"-enter-to"),t.classList.remove(D+"-enter-from"),"fold-height"==D?t.style.height=i:"fold-width"==D&&(t.style.width=s),t.addEventListener("transitionend",U)}))}))}),s)}else{t.style.animationDelay="0s";let s=1e3*parseFloat(W);setTimeout((()=>{requestAnimationFrame((()=>{t.classList.remove(P+"-leave-to"),""!=S&&(t.style.animationDuration=S),"ease"!=L&&(t.style.animationTimingFunction=S),x&&(t.style.display=""),F&&F.apply(e.model,[e]),t.offsetWidth,t.classList.add(D+"-enter-active"),t.addEventListener("animationend",U)}))}),s)}}function _(e){if("none"==e.style.display){const t=window.getComputedStyle(e).getPropertyValue("position"),s=window.getComputedStyle(e).getPropertyValue("visibility");e.style.position="absolute",e.style.visibility="hidden",e.style.display="";let i=window.getComputedStyle(e).getPropertyValue("width"),n=window.getComputedStyle(e).getPropertyValue("height");return e.style.position=t,e.style.visibility=s,e.style.display="none",[i,n]}return[window.getComputedStyle(e).getPropertyValue("width"),window.getComputedStyle(e).getPropertyValue("height")]}}),10),EventManager.regist("tap",{touchstart(e,t,s,i){let n=i.touches[0];s.dependEvent.setParam(t,e,"pos",{sx:n.pageX,sy:n.pageY,t:Date.now()})},touchmove(e,t,s,i){let n=s.dependEvent.getParam(t,e,"pos");if(!n)return;let r=i.touches[0],o=r.pageX-n.sx,a=r.pageY-n.sy;(Math.abs(o)>5||Math.abs(a)>5)&&(n.move=!0)},touchend(e,t,s,i){let n=s.dependEvent.getParam(t,e,"pos");if(!n)return;s.dependEvent.removeParam(t,e,"pos");let r=Date.now()-n.t;if(!n.move&&r<200){let n=s.dependEvent.handler;"string"==typeof n?t.invokeMethod(s.dependEvent.handler,e.model,e,s.dependEvent,i):n.apply(t,[e.model,e,s.dependEvent,i])}}}),EventManager.regist("swipe",{touchstart(e,t,s,i){let n=i.touches[0],r=Date.now();s.dependEvent.setParam(t,e,"swipe",{oldTime:[r,r],speedLoc:[{x:n.pageX,y:n.pageY},{x:n.pageX,y:n.pageY}],oldLoc:{x:n.pageX,y:n.pageY}})},touchmove(e,t,s,i){let n=Date.now(),r=i.touches[0],o=s.dependEvent.getParam(t,e,"swipe");n-o.oldTime[1]>50&&(o.speedLoc[0]={x:o.speedLoc[1].x,y:o.speedLoc[1].y},o.speedLoc[1]={x:r.pageX,y:r.pageY},o.oldTime[0]=o.oldTime[1],o.oldTime[1]=n),o.oldLoc={x:r.pageX,y:r.pageY}},touchend(e,t,s,i){let n=s.dependEvent.getParam(t,e,"swipe"),r=Date.now(),o=r-n.oldTime[1]<30?0:1,a=n.oldLoc.x-n.speedLoc[o].x,l=n.oldLoc.y-n.speedLoc[o].y,d=Math.sqrt(a*a+l*l),c=r-n.oldTime[o];if(c>300||d<10)return;let u=d/c;if(u>.05){let n="";if(a<0&&Math.abs(l/a)<1&&(i.v0=u,n="swipeleft"),a>0&&Math.abs(l/a)<1&&(i.v0=u,n="swiperight"),l>0&&Math.abs(a/l)<1&&(i.v0=u,n="swipedown"),l<0&&Math.abs(a/l)<1&&(i.v0=u,n="swipeup"),s.dependEvent.name===n){let n=s.dependEvent.handler;"string"==typeof n?t.invokeMethod(n,e.model,e,s.dependEvent,i):"function"==typeof n&&n.apply(t,[e.model,e,s.dependEvent,i])}}}}),EventManager.regist("swipeleft",EventManager.get("swipe")),EventManager.regist("swiperight",EventManager.get("swipe")),EventManager.regist("swipeup",EventManager.get("swipe")),EventManager.regist("swipedown",EventManager.get("swipe")),EventManager.regist("dblclick",{click(e,t,s,i){let n=s.dependEvent.getParam(t,e,"firstClick");if(n){if(Date.now()-n<300){let n=s.dependEvent.handler;"string"==typeof n?t.invokeMethod(s.dependEvent.handler,e.model,e,s.dependEvent,i):n.apply(t,[e.model,e,s.dependEvent,i])}}else s.dependEvent.setParam(t,e,"firstClick",Date.now());setTimeout((()=>{s.dependEvent.removeParam(t,e,"firstClick")}),500)}});class NModuleNode extends NNode{constructor(e,t){super(e,t),this.path=e.path}run(){return s(this,void 0,void 0,(function*(){if(this.module||(yield this.getModule()),!this.module)throw`module '${this.name}'不存在`;this.module.setContainer(this.process.container),this.process.setCurrentNode(this),this.module.process=this.process,Renderer.add(this.module)}))}getModule(){return s(this,void 0,void 0,(function*(){const e=yield import(this.path);for(let t of Object.keys(e))if(e[t].name)return void(this.module=ModuleFactory.get(e[t]))}))}}class NEndNode extends NNode{run(){this.process.end()}}class NExpression{constructor(e){if(!e)return;const t=this.compile(e);this.execFunc=new Function("$model","return "+t)}compile(e){const t=/('[\s\S]*?')|("[\s\S]*?")|(`[\s\S]*?`)|([a-zA-Z$_][\w$]*\s*?:)|((\.{3}|\.)?[a-zA-Z$_][\w$]*(\.[a-zA-Z$_][\w$]*)*(\s*[\[\(](\s*\))?)?)/g;let s,i="",n=0;for(;null!==(s=t.exec(e));){let o=s[0];if(n<s.index&&(i+=e.substring(n,s.index)),"'"===o[0]||'"'===o[0]||"`"===o[0])i+=o;else{let e=o[o.length-1];if(":"===e)i+=o;else if("("===e||")"===e)i+=r(o);else if(o.startsWith("this.")||"$model"===o||o.startsWith("$model.")||this.isKeyWord(o)||"."===o[0]&&"."!==o[1])i+=o;else{let e="";o.startsWith("...")&&(e="...",o=o.substring(3)),i+=e+"$model."+o,-1!==o.indexOf(".")&&(this.allModelField=!1)}}n=t.lastIndex}return n<e.length&&(i+=e.substring(n)),i;function r(e){let t=e.indexOf(".");if(-1===t){let t=e.lastIndexOf("("),s=e.substring(0,t);if(!this.isKeyWord(s)){return")"!==e[e.length-1]?'this.invokeMethod("'+s+'",':'this.invokeMethod("'+s+'")'}}else if("."!==e[0]){let s=e.substring(0,t);if(!this.isKeyWord(s))return"$model."+e}return e}}val(e){let t;try{t=this.execFunc.apply(null,[e])}catch(e){}return this.value=t,t}isKeyWord(e){return["arguments","boolean","break","byte","catch","char","const","default","delete","do","double","else","enum","eval","false","float","for","function","goto","if","in","instanceof","int","let","long","new","null","return","short","switch","this","throw","true","try","this","throw","typeof","var","while","with","Array","Date","JSON","Set","Map","eval","function","Infinity","isFinite","isNaN","isPrototypeOf","Math","NaN","Number","Object","prototype","String","isPrototypeOf","undefined","valueOf"].includes(e)}}class NParallelNode extends NNode{constructor(e,t){super(e,t)}run(){return s(this,void 0,void 0,(function*(){if(0==--this.inCount)for(let e of this.outSequences)e.run()}))}init(){if(this.outSequences=this.process.getSequenceNodes(this.name),this.outSequences=this.process.getSequenceNodes(this.name),this.inSequences=this.process.getSequenceNodes(this.name,!0),!this.outSequences||0===this.outSequences.length||!this.inSequences||0===this.inSequences.length)throw`节点'${this.name}'配置错误!`;this.inCount=this.inSequences.length}}class NSequenceNode extends NNode{constructor(e,t){super(e,t),this.src=e.src,this.dst=e.dst,e.cond&&(this.expr=new NExpression(e.cond))}run(){const e=this.process.getNode(this.dst);if(!e)throw"目标节点不存在";if(e instanceof NParallelNode)e.run();else{if(this.expr&&!this.expr.val(this.process.getParam()))return!1;e.run()}return!0}}class NStartNode extends NNode{run(){const e=this.process.getSequenceNode(this.name);e&&e.run()}}class NExclusiveNode extends NNode{constructor(e,t){super(e,t)}run(){return s(this,void 0,void 0,(function*(){for(let e of this.outSequences)if(e.run())break}))}init(){if(this.outSequences=this.process.getSequenceNodes(this.name),!this.outSequences||0===this.outSequences.length)throw`节点'${this.name}'配置错误!`}}class NInclusiveNode extends NNode{constructor(e,t){super(e,t)}run(){return s(this,void 0,void 0,(function*(){if(0==--this.inCount)for(let e of this.outSequences)e.run()}))}init(){if(this.outSequences=this.process.getSequenceNodes(this.name),this.inSequences=this.process.getSequenceNodes(this.name,!0),!this.outSequences||0===this.outSequences.length||!this.inSequences||0===this.inSequences.length)throw`节点'${this.name}'配置错误!`;this.inCount=this.inSequences.length}}class NPageProcess{constructor(e,t,s){this.params={},this.id=e,this.name=t.name,this.title=t.title,this.container=s,this.handleNodes(t.nodes)}handleNodes(t){const s=[];for(let i of t){let t;switch(i.type){case e.START:t=new NStartNode(i,this);break;case e.END:t=new NEndNode(i,this);break;case e.MODULE:t=new NModuleNode(i,this);break;case e.SEQUENCE:t=new NSequenceNode(i,this);break;case e.EXCLUSIVE:t=new NExclusiveNode(i,this);break;case e.INCLUSIVE:t=new NInclusiveNode(i,this);break;case e.PARALLEL:t=new NParallelNode(i,this)}s.push(t)}this.nodes=s,this.doNodeInit(),console.log(this.nodes)}doNodeInit(){for(let e of this.nodes)e.init&&e.init.apply(e)}getParam(e){if(this.params)return e?this.params[e]:this.params}setParam(e,t){e?this.params[e]=t:this.params=t}start(){const e=this.nodes.find((e=>e instanceof NStartNode));if(!e)throw"流程无开始节点";e.run()}end(){delete this.currentNode,this.finished=!0}getNode(e){return this.nodes.find((t=>t.name===e))}setCurrentNode(e){this.currentNode&&this.currentNode instanceof NModuleNode&&this.currentNode.module.unmount(),this.currentNode=e}next(){if(!this.currentNode)return;let e=this.getSequenceNode(this.currentNode.name);e&&e.run()}getSequenceNode(e,t){return t?this.nodes.find((t=>t.dst===e)):this.nodes.find((t=>t.src===e))}getSequenceNodes(e,t){return t?this.nodes.filter((t=>t.dst===e)):this.nodes.filter((t=>t.src===e))}}class NPageEngine{static createProcess(e,t){const s=this.processId++;return new NPageProcess(s,t,e)}static getProcess(e){}}NPageEngine.processId=1,NPageEngine.processMap=new Map;export{e as ENodeType,NEndNode,NExclusiveNode,NInclusiveNode,NModuleNode,NNode,NPageEngine,NPageProcess,NParallelNode,NSequenceNode,NStartNode};
//# sourceMappingURL=npageflow.min.js.map
